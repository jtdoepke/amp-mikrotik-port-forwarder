# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Build and Development Commands

```bash
# Build
go build -o amp-port-sync .

# Run tests
go test ./...

# Run a single test
go test ./internal/sync -run TestCollectPorts

# Lint (uses golangci-lint as a go tool dependency)
go tool golangci-lint run

# Format
go tool golangci-lint fmt

# Generate mocks (uses mockery as a go tool dependency)
go tool mockery
```

## Architecture

This tool synchronizes port forwarding rules from CubeCoders AMP game server manager to a chain of Mikrotik routers.

### Core Flow

1. **AMP Client** (`internal/amp/`) polls the AMP API for running game server instances and extracts their ports
2. **Reconciler** (`internal/sync/reconciler.go`) compares desired ports against current router rules
3. **Mikrotik Client** (`internal/mikrotik/`) creates/updates firewall rules via the RouterOS API

### Router Chain Model

Routers are configured in order from WAN-facing to internal:
- **Router[0]** (first): Creates WAN dstnat + hairpin NAT rules for LAN clients
- **Router[1..N-1]** (subsequent): Creates dstnat + forward filter rules

Rules are identified by comment patterns (e.g., `amp-sync:wan-dstnat:tcp`) and updated in-place when ports change. The tool queries routers directly by comment to find existing rules - no state file is needed.

### Key Interfaces

- `amp.Client` - Fetches game server instances from AMP
- `mikrotik.RouterClient` - Manages firewall rules on a router

Both have mock implementations generated by mockery for testing.

### Configuration

Configuration is done via CLI flags and environment variables:
- CLI flags: `--amp-url`, `--amp-username`, `--router`, etc.
- Environment variables with `AMP_SYNC_` prefix
- Password files supported for K8s-style mounted secrets

No config file is used. See `cmd/sync.go` for flag definitions.

## Workflow

- Update the CHANGELOG before commits
- When making a version release and updating the CHANGELOG, make sure to update the links at the bottom of the CHANGELOG
- Always use annotated git tags for versioned releases
